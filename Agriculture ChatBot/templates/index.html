<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agriculture Chatbot - Groq</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Smooth transition for the chat panel */
    #chatPanel.hidden { display: none; }
  </style>
</head>
<body class="bg-green-50 text-gray-800 font-sans min-h-screen">

  <button id="openChat" class="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl hover:bg-green-700 font-bold flex items-center gap-2 z-50">
    <span>üåæ</span> Open Agriculture Chat
  </button>

  <div id="chatPanel" class="fixed bottom-24 right-6 max-w-lg w-full bg-white rounded-2xl shadow-2xl p-6 hidden z-50 border border-green-100 ring-1 ring-black ring-opacity-5">
    
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h1 class="text-xl font-bold text-green-700">üåæ Agribot Assistant</h1>
      <button id="closeChat" class="text-gray-400 hover:text-red-500 text-3xl leading-none">&times;</button>
    </div>

    <p class="text-sm text-gray-600 mb-4">Ask farming questions by typing or uploading voice</p>

    <form id="textForm" class="flex gap-2 mb-4">
      <input
        type="text"
        id="textInput"
        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
        placeholder="Type your question..."
        autocomplete="off"
      />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">Ask</button>
    </form>

    <form id="audioForm" enctype="multipart/form-data" class="flex gap-2 mb-4">
      <input
        type="file"
        id="audioInput"
        accept="audio/*"
        class="flex-1 text-xs border border-gray-300 rounded-lg file:mr-2 file:py-2 file:px-4 file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
      />
      <button type="submit" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-700">Upload</button>
    </form>

    <div id="result" class="bg-gray-50 p-4 rounded-lg shadow-inner hidden max-h-60 overflow-y-auto" role="region">
      <h2 class="font-semibold text-sm text-green-800 mb-1">üìù Answer:</h2>
      <p id="responseText" class="text-sm text-gray-700 mb-3 whitespace-pre-wrap"></p>
      <audio id="audioPlayer" controls class="w-full hidden h-8"></audio>
    </div>
  </div>

  <script>
    // Panel Toggle Logic
    const chatPanel = document.getElementById('chatPanel');
    const openBtn = document.getElementById('openChat');
    const closeBtn = document.getElementById('closeChat');

    openBtn.onclick = () => {
      chatPanel.classList.remove('hidden');
      openBtn.classList.add('hidden');
    };

    closeBtn.onclick = () => {
      chatPanel.classList.add('hidden');
      openBtn.classList.remove('hidden');
    };

    // --- YOUR ORIGINAL LOGIC BELOW ---

    // Text Form
    document.getElementById('textForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('textInput').value.trim();
      if (!text) return;

      const formData = new FormData();
      formData.append('text', text);

      try {
        const res = await fetch('/chat', { method: 'POST', body: formData });
        const data = await res.json();
        showResponse(data.text, data.voice);
      } catch (err) {
        alert('Error communicating with server.');
      }
    });

    // Audio Form
    document.getElementById('audioForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('audioInput');
      if (!fileInput.files.length) return alert('Please select an audio file.');

      const formData = new FormData();
      formData.append('audio', fileInput.files[0]);

      try {
        const res = await fetch('/chat', { method: 'POST', body: formData });
        const data = await res.json();
        showResponse(data.text, data.voice);
      } catch (err) {
        alert('Error communicating with server.');
      }
    });

    function showResponse(text, voiceUrl = null) {
      const resultDiv = document.getElementById('result');
      const responseText = document.getElementById('responseText');
      const audioPlayer = document.getElementById('audioPlayer');

      responseText.textContent = text;
      resultDiv.classList.remove('hidden');

      if (voiceUrl) {
        audioPlayer.src = voiceUrl;
        audioPlayer.classList.remove('hidden');
        audioPlayer.load();
      } else {
        audioPlayer.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
